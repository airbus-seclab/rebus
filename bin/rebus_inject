#! /usr/bin/env python


import os
import subprocess
from  rebus.reagent import REagent, REdescriptor
import logging


def guess_selector(fname):
    guess = subprocess.check_output(["file", "-L", fname])
    if "ELF" in guess:
        return "/binary/elf"
    if "PE" in guess:
        return "/binary/pe"
    if "DOS" in guess:
        return "/binary/dos"
    if "Mach-O" in guess:
        return "/binary/macho"
    return "/unknown"


def main():
    import argparse
    
    parser = argparse.ArgumentParser()
    parser.add_argument("files", nargs="+",
                        help="inject FILES into the bus")
    parser.add_argument("--selector", "-s", 
                        help="Use SELECTOR")
    parser.add_argument("--domain", "-d", default="default",
                        help="Work in DOMAIN")
    parser.add_argument("--label", "-l", 
                        help="Use LABEL instead of file name")

    options = parser.parse_args()

    logging.basicConfig(level=logging.INFO)

    agent = REagent("inject", domain=options.domain)

    for f in options.files:
        label = options.label if options.label else os.path.basename(f)
        data = open(f).read()
        selector =  options.selector if options.selector else  guess_selector(f)
        desc = REdescriptor(label, selector, data, options.domain)
        agent.push(desc)

    


if __name__ == "__main__":
    main()
